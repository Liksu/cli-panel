/**
 * cli-panel - Command line interface for sites
 * @author Liksu
 * @version v1.0.0-beta.3
 * @link http://liksu.github.io/cli-panel/
 * @license MIT
 */
"use strict";function _typeof(e){return e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e}function _typeof(e){return e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e}window.cli=new function(){var e=this,t=this;this.cache={commandInput:null,buffer:null,panel:null,show:!1,loading:!1},this.history=[],this.settings={prompt:"> ",tab:"    ",debug:0},this.workers={pre:[],commands:{},post:[],keys:{}},localStorage&&localStorage.cliHistory&&(this.history=JSON.parse(localStorage.cliHistory)),this.templates={},this.addHtml=function(e,t,n){this.templates[e]={html:t,selector:n||"body"}}.bind(this),this.init=function(e){var t=this;if(this.cache.inited)return void 0;"object"===("undefined"==typeof e?"undefined":_typeof(e))&&Object.keys(e).forEach(function(n){return t.settings[n]=e[n]});var n=this.templates,i={};Object.keys(n).forEach(function(e){var t=n[e].selector;i[t]||(i[t]=document.createElement("div"),i[t].className="cli cli-panel",i[t].id="cli",i[t].innerHTML=""),i[t].innerHTML+=n[e].html}),Object.keys(i).forEach(function(e){document.querySelector(e).appendChild(i[e])}),this.cache.panel=document.querySelector(".cli.cli-panel"),this.cache.panel.addEventListener("mouseup",this.mouseUp),this.cache.line=this.cache.panel.querySelector(".cli-line"),this.cache.commandInput=this.cache.panel.querySelector(".cli .cli-line .cli-command"),this.cache.buffer=this.cache.panel.querySelector(".cli-history"),this.cache.loader=this.cache.panel.querySelector(".cli-loader"),this.cache.prompt=this.cache.panel.querySelector(".cli-prompt"),this.setPrompt(),window.onresize=function(){return t.toggleScroll()},this.toggle(this.cache.show),this.cache.inited=!0}.bind(this),document.addEventListener("DOMContentLoaded",this.init),document.addEventListener("keydown",function(e){var t=e.target===this.cache.commandInput;this.workers.keys[e.keyCode]&&this.workers.keys[e.keyCode].forEach(function(n){return n.worker(e,t)}),this.workers.keys[0]&&this.workers.keys[0].forEach(function(n){return n.worker(e,t)})}.bind(this)),this.show=function(){this.cache.panel.className+=" show",this.cache.show=!0,this.focus()}.bind(this),this.hide=function(){this.cache.panel.className=this.cache.panel.className.replace(/\s*show/g,""),this.cache.show=!1}.bind(this),this.toggle=function(e){void 0===e&&(e=!this.cache.show),e?this.show():this.hide()}.bind(this),this.toggleScroll=function(){var e=this.cache.panel.offsetHeight-this.cache.line.offsetHeight;this.cache.buffer.style.height=this.cache.buffer.offsetHeight>e?e+"px":"auto",this.cache.buffer.scrollTop=this.cache.buffer.scrollHeight}.bind(this),this.mouseUp=function(e){var t="";window.getSelection?t=window.getSelection().toString():document.selection&&"Control"!=document.selection.type&&(t=document.selection.createRange().text),t||e.target===this.cache.commandInput||this.focus()}.bind(this),this.focus=function(){var e=this.cache.commandInput;setTimeout(function(){var t=e.value.length;if(e.setSelectionRange)e.setSelectionRange(t,t);else if("number"==typeof e.selectionStart)e.selectionStart=e.selectionEnd=t;else if("undefined"!=typeof e.createTextRange){e.focus();var n=e.createTextRange();n.collapse(!0),n.moveEnd(t),n.moveStart(t),n.select()}e.focus()},0)}.bind(this),this.startLoading=function(){e.cache.loading=!0,e.cache.loader.className=e.cache.loader.className.replace(/\s*hide_element\s*/,""),e.cache.line.className+=" hide_element",e.cache.commandInput.disabled=!0;var t=[{"char":"|",duration:100},{"char":"/",duration:80},{"char":"-",duration:100},{"char":"\\",duration:80}].map(function(n,i,o){return function(){var e=this;this.cache.loader.innerHTML=n["char"],setTimeout(function(){e.cache.loading&&t[i===o.length-1?0:i+1]()},n.duration)}.bind(e)});t[0]()},this.stopLoading=function(){e.cache.loading=!1,e.cache.loader.innerHTML="done",e.cache.loader.className+=" hide_element",e.cache.line.className=e.cache.line.className.replace(/\s*hide_element\s*/,""),e.cache.commandInput.disabled=!1,e.focus()},this.log=function(){for(var t=arguments.length,n=Array(t),i=0;t>i;i++)n[i]=arguments[i];e.settings.debug},this.stringify=function(e){var t=[];return JSON.stringify(e,function(e,n){if(null!=n&&"object"==("undefined"==typeof n?"undefined":_typeof(n))){var i;if((i=t.indexOf(n))>=0)return"$ref:"+i;t.push(n)}return n})},this.setPrompt=function(e,t){void 0===e?e=this.settings.prompt:t&&(this.settings.prompt=e),this.cache.prompt.innerHTML=e}.bind(this),this.print=function(e){this.toggleScroll(),this.cache.buffer.innerHTML+=(""+e).replace(/\t/g,this.settings.tab)+"\n"}.bind(this),this.run=function(e){var n=this;if(e){this.history.push(e.trim());var i=void 0,o=this.history.length;do i=JSON.stringify(this.history.slice(-o--));while(i.length>2e6);localStorage.cliHistory=i}var r={input:e.trim(),original:e,command:null,argv:{},result:null},c=new Promise(function(e,t){n.startLoading(),e(r)});return this.workers.pre.forEach(function(e){return e.forEach(function(e){t.log("promise pre",e),c=c.then(function(t){return e.worker(t)||t})})}),c=c.then(function(e){return new Promise(function(i,o){t.log("promise command",e);var r;return e.command&&(r=n.workers.commands[e.command])?(t.log("promise run command",r),i(r.worker(e)||e)):i(e)})}).then(function(e){return e||r}),this.workers.post.forEach(function(e){return e.forEach(function(e){t.log("promise post",e),c=c.then(function(t){return e.worker(t)||t})})}),c.then(function(e){n.stopLoading(),n.toggleScroll()})}.bind(this);var n=function(e,n,i,o,r){r||(r=0),void 0===o&&"function"==typeof i&&(o=i,i=null);var c={name:n,description:i,worker:function(){for(var i=arguments.length,r=Array(i),c=0;i>c;c++)r[c]=arguments[c];t.log("call worker",e,n,"with arguments:",r);var s=o.apply(null,r);return t.log("and result:",s),s}};"command"===e?this.workers.commands[n]=c:"keys"===e?(this.workers.keys[n]||(this.workers.keys[n]=[]),this.workers.keys[n].push(c)):(this.workers[e][r]||(this.workers[e][r]=[]),this.workers[e][r].push(c))}.bind(this);this.command=n.bind(this,"command"),this.preprocessor=n.bind(this,"pre"),this.postprocessor=n.bind(this,"post"),this.registerKey=n.bind(this,"keys")},window.cli.version="1.0.0-beta.3",function(e){e.command("clear","Clear screen",function(t){e.log("execute command clear"),e.cache.buffer.innerHTML=""})}(window.cli),function(e){e.command("help","Display this list",function(t){e.log("execute command help"),e.print("Command line interface for sites."),e.print("Version: "+e.version),e.print(""),e.print("List of available commands:"),Object.keys(e.workers.commands).sort().forEach(function(t){var n=e.workers.commands[t].description;e.print(["	",t,n?"- "+n:""].join(" "))})})}(window.cli),function(e){e.registerKey(9,"Tab",function(t,n){if(e.log("process key Tab for autocomplete"),n){t.preventDefault();var i=e.cache.commandInput.value;i=new RegExp("^"+i);var o=Object.keys(e.workers.commands).sort(function(e,t){return e.length-t.length}).filter(function(e){return i.test(e)});o.length&&(1===o.length?e.cache.commandInput.value=o[0]+" ":e.print(o.join("	")))}})}(window.cli),function(e){e.registerKey(0,"Echo",function(t,n){e.log("echo pressed key",t.keyCode,t)})}(window.cli),function(e){function t(t){e.cache.commandInput.value=t,e.focus()}var n="",i=0;e.registerKey(38,"Up",function(o,r){e.log("process key Up for history"),r&&i!=e.history.length&&(i||(n=e.cache.commandInput.value),i++,i>e.history.length&&(i=e.history.length),t(e.history[e.history.length-i]))}),e.registerKey(40,"Down",function(o,r){if(e.log("process key Down for history"),r&&i){i--;var c="";0>=i?(i=0,c=n):c=e.history[e.history.length-i],t(c)}}),e.registerKey(13,"Enter",function(t,o){e.log("process key Enter for history"),n="",i=0})}(window.cli),function(e){e.registerKey(13,"Enter",function(t,n){e.log("process key Enter for run"),n&&(e.print(e.cache.prompt.outerHTML+e.cache.commandInput.value),e.run(e.cache.commandInput.value),e.cache.buffer.scrollTop=e.cache.buffer.scrollHeight,e.cache.commandInput.value="")})}(window.cli),function(e){e.registerKey(192,"`",function(t,n){e.log("process key ` for show"),("INPUT"!==t.target.nodeName||n)&&(n&&t.preventDefault(),e.toggle())})}(window.cli),function(e){function t(e){for(;/[+-]{2}/.test(e);)e=e.replace(/([+-]{2})/,function(e){return r[e]});for(;s.test(e);)e=e.replace(s,"$1 $2 $3");return e=e.split(new RegExp(c)).map(function(e){return e.trim()}).filter(function(e){return""!==e}).map(function(e){return isNaN(+e)?e:+e}).filter(function(e,t,n){if("string"!=typeof e)return!0;if(-1===i.indexOf(e))throw new SyntaxError("invalid operator "+e);return!(0===t||t===n.length-1)}).join(" "),i.forEach(function(t){for(var n=[""].concat(t.split("")).join("\\"),i=new RegExp(c+" ("+n+") "+c);new RegExp(n).test(e);)e=e.replace(i,function(e,t,n,i){return o[n](+t,+i)})}),+e}function n(e){for(;/\(([^()]*)\)/.test(e);)e=e.replace(RegExp.lastMatch,t(RegExp.$1));return e=e.replace(/[()]/g,""),e=t(e),+e}var i="** log * / - +".split(" "),o={"+":function(e,t){return e+t},"-":function(e,t){return e-t},"*":function(e,t){return e*t},"/":function(e,t){return e/t},"**":function(e,t){return Math.pow(e,t)},log:function(e,t){return Math.log(e)/Math.log(t)}},r={"++":"+ ","--":"+ ","+-":"- ","-+":"- "},c="([-+]?(?:\\d*\\.)?\\d+(?:e[+-]?\\d+)?)",s=/(\d)([+-])([\d.])/g;e.postprocessor("calc","Simple calculator",function(t){e.log("execute POST processor calc");var o=t.input;if(!o)return t;if(!/([\/*+-]|log)/.test(o))return t;var r=i.map(function(e){return[""].concat(e.split("")).join("\\")}).concat(["\\s"]).join("|");o=o.split(new RegExp("("+r+")")).map(function(e){return-1===i.indexOf(e)&&isNaN(+e)&&"undefined"!=typeof window[e]?window[e]:e}).join("");try{t.result=n(o),e.print(t.result),t.input=""}catch(c){var s=c.name.split(/([A-Z])/g).filter(function(e){return e}).map(function(e,t){return e.toLowerCase()+(t%2?" ":"")}).join("").trim();e.print("Calculator "+s+": "+c.message)}return t})}(window.cli),function(e){e.postprocessor("eval","Run js code",function(t){var n=t.input;if(!n)return t;try{var i=t.result=new Function("return "+n)();e.print("object"!==("undefined"==typeof i?"undefined":_typeof(i))?i:e.stringify(i)),t.input=""}catch(o){e.print(o.name+": "+o.message)}return t},1e3)}(window.cli),function(e){function t(e){var t={_:[]};if(!e)return t;var n=e.match(/^(.*?)\s+\-\-\s+(.*)$/);if(n&&(e=n[1],n=n[2]),!e)return t._=[n],t;for(var i=e.split(""),o=[],r=!1,c=!1,s=[],a=0;a<=i.length;a++)if("\\"!==i[a])if(r)r=!1;else{if('"'===i[a]||"'"===i[a]){if(!c){o.push(s.join("").trim()),s=[],c={"char":i[a],position:a,text:[]};continue}if(c["char"]===i[a]){c.text=c.text.join(""),o.push(c),c=!1;continue}}c?c.text.push(i[a]):s.push(i[a])}else r=!0;for(o.push(s.join("").trim()),o=o.map(function(e){return"string"==typeof e?e.split(/\s+|=/):e}),o=[].concat.apply([],o),o=o.map(function(e){if(/^\-([^-]+)$/.test(e))return{flags:RegExp.$1.split("")};if(/^\-\-(.+)$/.test(e)){var t=RegExp.$1;return t=t.split("-").map(function(e){return e.charAt(0).toUpperCase()+e.slice(1)}).join(""),t=t.charAt(0).toLowerCase()+t.slice(1),{param:t}}return e}),o=o.map(function(e){return e.text||e}),o.push(n);o.length;){var l=o.shift();if(l)if("object"!==("undefined"==typeof l?"undefined":_typeof(l)))t._.push(l);else{var u=l.param;if(l.flags)for(u=l.flags.pop();l.flags.length;)t[l.flags.shift()]=!0;if("string"==typeof o[0]){t[u]=o.shift(),!isNaN(parseFloat(t[u]))&&isFinite(t[u])&&(t[u]=+t[u]);var h={"true":!0,"false":!1,"null":null,undefined:void 0};h.hasOwnProperty(t[u])&&(t[u]=h[t[u]])}else t[u]=!0}}return t}e.preprocessor("argv","Split command line to arguments",function(n){if(e.log("execute PRE processor argv"),!n.input)return n;n.command=null;var i=Object.keys(e.workers.commands).sort(function(e,t){return t.length-e.length});return i.some(function(e){return 0===n.input.indexOf(e)&&(n.command=e,n.input=n.input.replace(e,"").trim()),n.command}),n.command&&(n.argv=t(n.input),n.input=""),e.log("argv result",n),n})}(window.cli),function(e){e.addHtml("templates/panel.html",'<div class="cli-history"></div><div class="cli-loader hide_element"></div><div class="cli-line"><span class="cli-prompt"></span><input type="text" autofocus="autofocus" class="cli-command"/></div>',"body")}(window.cli),!function(){var e="body #cli.cli.cli-panel {\n  z-index: 65535;\n  top: 0;\n  left: 0;\n  max-height: 64%;\n  height: 0;\n  position: absolute;\n  right: 0;\n  color: white;\n  font: 16px monospace;\n  background: rgba(0, 0, 0, 0.8);\n  line-height: 20px;\n  transition: height 0.64s linear; }\n  body #cli.cli.cli-panel.show {\n    height: 64%; }\n  body #cli.cli.cli-panel .cli-history {\n    overflow: auto;\n    white-space: pre-wrap;\n    position: absolute;\n    bottom: 20px;\n    width: 100%; }\n    body #cli.cli.cli-panel .cli-history .cli-prompt {\n      display: inline;\n      width: auto; }\n  body #cli.cli.cli-panel .cli-line {\n    position: absolute;\n    bottom: 0;\n    height: 20px;\n    width: 100%;\n    display: table; }\n  body #cli.cli.cli-panel .cli-prompt {\n    display: table-cell;\n    width: 1px; }\n  body #cli.cli.cli-panel input[type=text].cli-command {\n    background: none;\n    border: 0;\n    color: white;\n    outline: none;\n    font: 16px monospace;\n    padding-left: 9px;\n    width: 100%;\n    box-sizing: border-box;\n    display: table-cell; }\n  body #cli.cli.cli-panel .cli-loader {\n    position: absolute;\n    bottom: 0;\n    height: 20px; }\n  body #cli.cli.cli-panel .hide_element {\n    display: none; }\n",t=document.createElement("style");t.type="text/css",t.styleSheet?t.styleSheet.cssText=e:t.appendChild(document.createTextNode(e)),(document.head||document.getElementsByTagName("head")[0]).appendChild(t)}();